#Building a full version of QNial7 

This directory is used to build a full executable version of QNial7 that
extends the core to hold the features described in a package descriptor 
file. The directory BuildNial has the following structure:


Entry          | Contents                                   
-------------- | ---------------------------------------- 
README.md      | The file you are currently reading 
build          | directory used by CMake, initially empty
pkgblder       | The directory used to select a package and add features
src            | filled by pkgblder with source code  and CmakeLists.txt, 
               | initially empty
support        | support directories for different platforms
testing        | directories for testing QNial7 versions
tools          | software tools

At the moment the Windows version is built as a Cross Compilation on Linux
using the MinGW-w64 (GCC) compilation tools. We provide pre-compiled 
binaries for Windows with all the supported features.

##Requirements

The build process uses CMake and requires that you have installed this. You can
use either the command line version of CMake or the GUI.

Both the CLANG compiler and GCC can be used to build Nial so that you will need
to have installed one of these compilers. On OSX you should install *XCode*,
on Linux use the appropriate package manager for your distribution. CLANG appears
to generate slightly faster code on Linux.

If you are cross compiling the Windows version then you will need to have installed 
the Mingw-w64 tools. This is best done using the package manager on your Linux system.
A CMake Toolchain file is provided in the tools subdirectory and its use is noted
in the following lines. It only needs to be used in the final build stage when you
are adding feaures and building a Windows version.

#Building a QNial7 version using pkkblder

A QNial7 exeutable includes the core functionality built using BuildCore, the
extensions that add the functionality described in the document 
   ../doc/V7 Nial Extensions.pdf,
and additional features of interest to some users. 

A QNial7 package builds an executable that consists of the core and and the 
set of features described in its <package>.txt file. The work to assemble
the src for the package and a corresponding CmakeLists.txt file is done in 
the directory "pkgblder".

The directory pkgblder has the following structure:

Entry             | Contents                                   
---------------   | ---------------------------------------- 
addfeatures.ndf   | Nial script that generates the ../src directory
allfeatures       | directory of subdirectories for each feature       
buildfromcore.ndf | Nial script that builds a basic version from the core
Cmake*            | three files used to generate CmakeLists.txt
coreprims.nh      | descriptor file for the core primitives
corenial          | core version of generated by Buildcore 
nial_basic        | basic version generated using package "basic_nial.txt"
nial              | standard version of generated using package "qnial7.txt"
nialcoredefs.ndf  | Nial definitions written added for all versions.
packages          | directory of package files
src_nialcore      | src files copied to the ../src directory



The directory BuildNial is used to build either a basic version of Nial that 
adds just a set of definitions written in Nial to the initial workspace or 
to build a Nial version that includes a number of features that have been 
added in QNial7. There are also some optional features that may
be added if desired.

The basic version is built first with the following steps:

1. Change to  BuildNial directory:	
   $ cd BuildNial

2. Clear the build and src subdirectories:
   $ rm -r build/*
   $ rm -r src/*

3. Change to the directory pkgblder to build the basic version:
   $ cd pkgblder

4. Run the Nial script buildfromcore.ndf to populate the src directory with the
   source code and CMakeLists.txt files:
   $ ./nialcore -defs buildfromcore

5. Nial can be
   built either as a 32 bit system or as a 64 bit system. This is controlled
   by options set in the *CMakeLists.txt* file in the source directory. You
   can also set a fast math option which sets the compiler flags appropriately.

6. If you are using the Cmake GUI then run it now with the source directory 
   set to BuildNial/src and the build directory to BuildNial/build. Then
   change to the build directory.

   If you are using the command line version of Cmake then do the following

   $ cd build
   $ cmake ../src
 
6. Do the make in the build directory to build executable nial:
   $ cd ../build
   $ make

7. Test the nial executable in build by running it interactively using
   $ ./nial -i

   This will display a header and a prompt of 5 spaces.
   Enter he nial expression: 
        5 + count 10

   It displays the result:

   6 7 8 9 10 11 12 13 14 15

   This example shows that the definition of count as

       count IS OPERATION A { 1 + tell A }

   has been installed correctly.

8. Move the nial executable into the pkgblder directory and rename it nial_basic:
   $ mv nial ../pkgblder/nial_basic

We have now completed the process of getting a nial executable that can be used
to add other features. 


#Creating Nial Packages

We define a "Nial package" as  basic nial extended by selected features.
The design of pkgblder is intended to be open ended so that new features can 
be developed and easily included in packages.

Each package file is described by a text file named <pkgname>.txt.

The first line of the file is a title for the package. It does not need
to be the same as the package name. The remaining lines provide the names of the 
features to be included from the list below. A line begining with # or that is
empty is ignored.

Each feature is given a name in all capitals thst is the name of its subdirectory.
The current set of features are:


DEBUGINCLUDED	adds DEBUG capability to basic nial
MEMSPACES       supports shared memory spaces  (Linux/OSX)
NCOMPLEX        complex arithmetic package
NDYNLOAD        supports dynamic loading (Linux/OSX)
NFILES          simple file features
NIALDSP         digital signal processing support
NIAL_FFTW       fast fourier transform support
NSFML_AUDIO     Audio support
NTABLES         user hash tables for associative array features
PROCESS         Unix style process control (Linux/OSX)
SOCKETS         Unix/Windows socket support
QSORT           Quicksort algorithm	
REGEXP          Posix regular expression support (Linux/OSX)
SPROCESS        support for streams (Lnux/OSX)
WINPROCESS      process support for Windows (Windows)

The subdirectory for a feature has one or more files and a subdirectory of src
files. For example, the REGEXP directory has:

REGEXP_src - the source directory
regexp.nh  - the descriptor file for primitives added with the feature
regexp.ndf - its definition to be installed at startup

The feature directory may also have a file with the name in lower case 
followed by _cmake for lines that need to be added to the CmakeLists.txt file 
for the feature.

The currently defined packages are:

basic_nial.txt      - builds basic_nial
basic_debug.txt     - builds a basic nial where the DEBUG facility can be 
                      turned on in Cmake to add integrity checks for testing
                      the core cpabilities.
QNial7.txt          - builds the standard V7 nial
allfeatures.txt     - builds all the features that are not commented out using #.
win_allfeaures.txt  - builds a Windows version with all applicable fearures


#Building a specific Package

1. Change to  BuildNial directory:	
   $ cd BuildNial

2. Clear the build and src subdirectories:
   $ rm -r build/*
   $ rm -r src/*

3. Change to the directory pkgblder: 
   $ cd pkgblder

4. Run the Nial script addfeatures.ndf to populate the src directory
   with the source code and CmakeLists.txt file:
   $ ./nial_basic -defs addfeatures

This will present a list of packages numbered from 0. Respond with the
number of the package you wish to create.

5. If you are using the CMake GUI then Run CMake pointing at the BuildNial 
   src and build directories. If you are building a Windows version then
   you will need to set the CMAKE_TOOLCHAIN_FILE variable to the 
   toolchain file found in the 'tools/CmakeTools' directory.
   
   If you are using the command line then do the following
   $cd build
   $cmake ../src
   
   or for thw Windows version
   $cd build
   $cmake -DCMAKE_TOOLCHAIN_FILE=../tools/CmakeTools/Toolchain-mingw64-Win64.cmake ../src
 

6. Do the make in the build directory to build executable "nial":
   $ cd ../build
   $ make

7. Test the nial executable in build using
   $ ./nial -i

   Try using one of the new primitives added by the package. For example if the
   feature QSORT is included in the package, test that qsort works as expected
   by entering the nial expression:
   
        qsort random 5
   0.119586 0.639681 0.72909 0.810901 0.882235

   The reulst is a set of random numbers between 0. and 1. sorted in ascending
   order. Enter

         bye

   to exit nial.

8. You have now completed the process of building a nial executable that 
   supports the features selected by the package. To make it the active
   executable "nial","copy it to a directory that is on your $PATH list. If you 
   have added a path to a provided version of nial using

   $ export PATH=$PATH:$HOME/QNial7/binaries/<platform>

   then copy the new executable to that directory. FOR OSX use

   $ cp nial $HOME/QNial7/binaries/OSX


# Adding new features


The pkgblder directory and the addfeatures.ndf Nial script have been designed
to make it straightforward to add new features to QNial7. The term feature
is used in this context to describe an extension to the Nial interpreter
that involves the addition of one or more new primitive functions each of
which may be a basic expression, a basic operation, or a basic  transformer.
The new primitives are implemented in C following the instruction give in 
Chapter 11 of the Design of QNial V7 document provided in QNial7/docs. The
implementation may involve one or more C source files and any corresponding
header files they require. A feature may also add additional functionality
in the form of Nial definitions that are installed at startup of the 
executable. 

Consider a new feature that we will call NEWFEATURE. We create a new directory
in BuildHelp/pkgblder/all_features with this name in capital letters. Within
this new directory we create a subdirectory NEWFEATURE_src. 
These steps are done with:
   $ cd all_features
   $ mkdir NEWFEATURE
   $ cd NEWFEATURE
   $ mkdir NEWFEATURE_src


Let us assume that the implementation of the two source files nf1.c and nf2.c
and a header file nf.h. These would be placed in NEWFEATURE_src. If there is 
a file of Nial definitions for the new feature then it must be named 
newfeature.ndf and placed in the NEWFEATURE directory.

In order for the interpreter to execute the new primitive functions a 
primitive descriptor file named newfeature.nh is created.  Each line of
the descriptor file describes one primitive function using the following form:
   NEWFEATURE Property Nialname Cname
where:
   Property is a single letter:
      U - a unary operation
      E - an expression
      T - a transformer
   Nialname is the name used for the primitive function in Nial
   Cname is the name of the C routine that implements the primitive function.
The newfeature.nh file is placed in the NEWFEATURE directory.

In some cases the new functionality being introduced will depend on support
libraries provide by the platform. The Cmake capability has to be provided
with the name of such libraries for the platforms that support the new 
feature. If this is the case a file named newfeature_cmake should contain
the lines that provide access to the library for the platforms being
supported. An example of such a file is found in the directory for the
feature that supports Fast Fourier transform capabilities, NIAL_FFTW. 
The file nial_fftw_cmake  contains the following lines:

if (${CMAKE_SYSTEM_NAME} MATCHES "Linux")
set(NIAL_LIBS ${NIAL_LIBS} fftw3)
endif (${CMAKE_SYSTEM_NAME} MATCHES "Linux")
if (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
set(NIAL_LIBS ${NIAL_LIBS} fftw3)
endif (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
if (${CMAKE_SYSTEM_NAME} MATCHES "Windows")
set(NIAL_LIBS ${NIAL_LIBS} fftw3-3)
endif (${CMAKE_SYSTEM_NAME} MATCHES "Windows")

If needed, create a similar file named newfeature_cmake in the NEWFEATURE
directory to supply the required support libraries.

When all these files have been set up, create a package file that includes an
entry for NEWFEATURE and build this package as described above.
